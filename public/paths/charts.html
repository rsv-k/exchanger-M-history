<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <link rel="stylesheet" href="../css/styles.css">
    <title>Charts</title>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="header__history">История</a>
        <div class="header">
            <div class="buttons">
                    <div class="wmcurrencies">
                        <button class = 'btn wmBtn active' id = "wmr">
                            <img class = 'currency_img' src="../Content/Images/currencies/wmr.png" alt="">
                            <span class = 'currency_value'>WMR</span></button>
                        <button class = 'btn wmBtn' id = "wmz">
                            <img class = 'currency_img' src="../Content/Images/currencies/wmz.png" alt="">
                            <span class = 'currency_value'>WMZ</span></button>
                    </div>
                    <div class="realcurrencies">
                        <button class = 'btn rlBtn active' id = "rub">
                            <img class = 'currency_img' src="../Content/Images/currencies/rub.png" alt="">
                            <span class = 'currency_value'>RUB</span></button>
                        <button class = 'btn rlBtn' id = "uah">
                            <img class = 'currency_img' src="../Content/Images/currencies/uah.png" alt="">
                            <span class = 'currency_value'>UAH</span></button>
                    </div>
                </div>
        </div>
        <div class="charts__container">
            <canvas id = "myChart_line_buy"></canvas>
            <canvas id = "myChart_line_sale"></canvas>
            <canvas id = "myChart_days"></canvas>
            <canvas id = "myChart_weeks" ></canvas>
        </div>
    </div>
</body>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.3"></script>
<script>
    let current_rlActive = 'RUB';
    let current_wmActive = 'WMR';
    const buttons = [...document.querySelectorAll('.btn')];
    const ctx_lineBuy = document.getElementById('myChart_line_buy').getContext('2d');
    const ctx_lineSale = document.getElementById('myChart_line_sale').getContext('2d');
    const ctx_days = document.getElementById('myChart_days').getContext('2d');
    const ctx_weeks = document.getElementById('myChart_weeks').getContext('2d');
    const charts = {
        bar: {
            days: null,
            weeks: null,
            months: null
        },
        line: {
            buy: null,
            sale: null
        }
    }

    buttons.forEach(btn => btn.addEventListener('click', currentCurrency))
    displayCharts(current_rlActive, current_wmActive);

    function currentCurrency(e) {
        const elem = e.currentTarget;
        if (elem.innerText === current_rlActive || elem.innerText === current_wmActive) return;

        const typeActive = elem.className.includes('wmBtn') ? 'wm' : 'rl';
        removeActive(typeActive);

        typeActive === 'wm' ? current_wmActive = elem.innerText : current_rlActive = elem.innerText;
        elem.classList.add('active');

        displayCharts(current_rlActive, current_wmActive);
    }

    function removeActive(type) {
        const buttons = [...document.querySelectorAll(`.${type}Btn`)];

        buttons.forEach(item => item.classList.remove('active'));
    }

    async function displayCharts(rlCurrency, wmCurrency) {
        const response = (await axios.get(`/history/${rlCurrency}-${wmCurrency}/api`.toLowerCase())).data;
        const dates = { labels: [], buy: {}, sale: {}, lineLabels_buy: [], lineLabels_sale: [], lineRates_buy: [], lineRates_sale: [], colorsBuy: [], colorsSale: [] };
        const amountWm = {
            buy: [],
            sale: []
        }

        for (let i = 0; i < response.length; i++) {
            const item = response[i];
            const date = item.FinishedAt.substring(0, 10);
            const type = item.BidsHistoryType;
            
            if (!dates.labels.includes(date)) dates.labels.push(date);

            const rate = rlCurrency === 'RUB' && wmCurrency === 'WMR' ? item.Rate 
            : 
            (item.Amount.replace(',', '.') / item.AmountWm.replace(',', '.')).toFixed(4);

            amountWm[type].push(+item.AmountWm.replace(',', '.'));
            dates[`lineRates_${type}`].push(rate);
            dates[`lineLabels_${type}`].push(item.FinishedAt + '\n' + 'Количество: ' + item.AmountWm);
            
            dates[type][date] = +((dates[type][date]  || 0 ) + (+item.AmountWm.replace(',', '.'))).toFixed(1);
        }
        const colors = { buy: [], sale: [] }
        let divisor = current_wmActive === 'WMR' ? 50000 : 500;
        let min = current_wmActive === 'WMR' ? 1000 : 100;

        for (let i = 0; i < Math.max(amountWm.buy.length, amountWm.sale.length); i++) {
            if (amountWm.buy[i]) colors.buy.push(`rgb(255, ${20 + Math.min(100, Math.floor((amountWm.buy[i] / divisor) * 100))}, 0)`);
            if (amountWm.sale[i]) colors.sale.push(`rgb(255, ${155 + Math.min(100, Math.floor((amountWm.sale[i] / divisor) * 100))}, 0)`);
        }
            
        const line = {
            ctx: ctx_lineBuy,
            chart: 'buy',
            labels: dates.lineLabels_buy,
            rates: dates.lineRates_buy,
            title: 'Покупка',
            colors: colors.buy,
            type: 'line',
            text: 'покупки'
        }
        const bar = {
            ctx: ctx_days,
            chart: 'days',
            labels: dates.labels,
            buy: Object.values(dates.buy),
            sale: Object.values(dates.sale),
            title: 'Дни',
            type: 'bar',
        }
        
        createChart(line);
        line.ctx = ctx_lineSale;
        line.chart = 'sale';
        line.labels = dates.lineLabels_sale;
        line.rates = dates.lineRates_sale;
        line.title = 'Продажа';
        line.colors = colors.sale;
        line.text = 'продажи';
        createChart(line);
        createChart(bar);

        const weeks = {
            buy: [],
            sale: [],
            labels: []
        }

        const maxLen = Math.max(bar.buy.length, bar.sale.length);
            
        for (let i = 0, p = 0; i < maxLen; i++) {
            if (i !== 0 && i % 7 === 0) p++;

            if (bar.sale[i]) weeks.sale[p] = +((weeks.sale[p] || 0) + bar.sale[i]).toFixed(1);
            if (bar.buy[i]) weeks.buy[p] = +((weeks.buy[p] || 0 ) + bar.buy[i]).toFixed(1);
        }
            
        for (let i = 0; i < dates.labels.length; i += 7) {
            weeks.labels.push(`${dates.labels[i]} - ${dates.labels[i + 6] || dates.labels[dates.labels.length - 1]}`);
        }

        bar.ctx = ctx_weeks;
        bar.labels = weeks.labels;
        bar.buy = weeks.buy;
        bar.sale = weeks.sale;
        bar.chart = 'weeks';
        bar.title = 'Недели';
        createChart(bar);
    }
















function updateLine(chart) {
    charts.line[chart.chart].data.labels = chart.labels;
    charts.line[chart.chart].data.datasets[0].data = chart.rates;
    charts.line[chart.chart].data.datasets[0].backgroundColor = chart.colors;
    charts.line[chart.chart].update();
}

function updateBar(chart) {
    charts.bar[chart.chart].data.labels = chart.labels;
    charts.bar[chart.chart].data.datasets[0].data = chart.buy;
    charts.bar[chart.chart].data.datasets[1].data = chart.sale;
    charts.bar[chart.chart].update();
}


function createChart(chart) {
    let options = null;
    let data = null;

    if (chart.type === 'bar') {
        if (charts[chart.type][chart.chart]) return updateBar(chart);
        options = {
            title: {
                display: true,
                text: chart.title,
                fontSize: 25,
                fontColor: '#fff'
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: '#fff'
                    }
                }],
                xAxes: [{
                    ticks: {
                        fontColor: '#fff'
                    }
                }]
            }
        }
        data = {
            labels: chart.labels,
            datasets: [
                {
                    label: 'Покупка',
                    data: chart.buy,
                    backgroundColor: '#00C0EF'
                },
                {
                    label: 'Продажа',
                    data: chart.sale,
                    backgroundColor: '#00A65A'
                }
            ]
        }
    }
    else if (chart.type === 'line') {
        if (charts[chart.type][chart.chart]) return updateLine(chart);
        options = {
            title: {
                display: true,
                fontSize: 25,
                fontColor: '#fff',
                text: 'Курс каждой ' + chart.text,
            },
            elements: {
                line: {
                    fill: false,
                    borderColor: 'rgba(0, 192, 239, 0.2)',
                    tension: 0
                },
                point: {
                    radius: 5
                }
            },
            scales:{
                xAxes: [{
                    display: false,
                }],
                yAxes: [{
                    ticks: {
                        fontColor: '#fff',
                    }
                }]
            },
            layout: {
                padding: {
                    right: 5
                }
            },
            legend: {
                display: false
            }
        }
        data = {
            labels: chart.labels,
            datasets: [{
                label: chart.title,
                data: chart.rates,
                backgroundColor: chart.colors,
            }]
        }
    }

    charts[chart.type][chart.chart] = new Chart(chart.ctx, {
        type: chart.type,
        data,
        options
    });
}
</script>
</html>