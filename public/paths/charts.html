<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
    <title>Charts</title>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="header__history">История</a>
            <div class="buttons">
                    <div class="wmcurrencies">
                        <button class = 'btn wmBtn active' id = "wmr">
                            <img class = 'currency_img' src="../Content/Images/currencies/wmr.png" alt="">
                            <span class = 'currency_value'>WMR</span></button>
                        <button class = 'btn wmBtn' id = "wmz">
                            <img class = 'currency_img' src="../Content/Images/currencies/wmz.png" alt="">
                            <span class = 'currency_value'>WMZ</span></button>
                    </div>
                    <div class="realcurrencies">
                        <button class = 'btn rlBtn active' id = "rub">
                            <img class = 'currency_img' src="../Content/Images/currencies/rub.png" alt="">
                            <span class = 'currency_value'>RUB</span></button>
                        <button class = 'btn rlBtn' id = "uah">
                            <img class = 'currency_img' src="../Content/Images/currencies/uah.png" alt="">
                            <span class = 'currency_value'>UAH</span></button>
                    </div>
                </div>
        </div>
        <div class="charts__container">
            <canvas id = "myChart_line_buy"></canvas>
            <canvas id = "myChart_line_sale"></canvas>
            <canvas id = "myChart_days"></canvas>
            <canvas id = "myChart_weeks" ></canvas>
        </div>
        
    </div>
    
</body>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    let current_rlActive = 'RUB';
    let current_wmActive = 'WMR';
    const buttons = [...document.querySelectorAll('.btn')];
    const ctx_lineBuy = document.getElementById('myChart_line_buy').getContext('2d');
    const ctx_lineSale = document.getElementById('myChart_line_sale').getContext('2d');
    const ctx_days = document.getElementById('myChart_days').getContext('2d');
    const ctx_weeks = document.getElementById('myChart_weeks').getContext('2d');
    const charts = {
        bar: {
            days: null,
            weeks: null,
            months: null
        },
        line: {
            buy: null,
            sale: null
        }
    }

    buttons.forEach(btn => btn.addEventListener('click', currentCurrency))
    displayCharts(current_rlActive, current_wmActive);

    function currentCurrency(e) {
        const elem = e.currentTarget;
        if (elem.innerText === current_rlActive || elem.innerText === current_wmActive) return;

        const typeActive = elem.className.includes('wmBtn') ? 'wm' : 'rl';
        removeActive(typeActive);

        typeActive === 'wm' ? current_wmActive = elem.innerText : current_rlActive = elem.innerText;
        elem.classList.add('active');

        displayCharts(current_rlActive, current_wmActive);
    }

    function removeActive(type) {
        const buttons = [...document.querySelectorAll(`.${type}Btn`)];

        buttons.forEach(item => item.classList.remove('active'));
    }

    function displayCharts(rlCurrency, wmCurrency) {
        axios.get(`/history/${rlCurrency}-${wmCurrency}/api`.toLowerCase())
        .then(response => {
            const dates = { labels: [], buy: {}, sale: {}, lineLabels_buy: [], lineLabels_sale: [], lineRates_buy: [], lineRates_sale: [], colorsBuy: [], colorsSale: [] };

            for (let i = 0; i < response.data.length; i++) {
                const item = response.data[i];
                const date = item.FinishedAt.substring(0, 10);
                const type = item.BidsHistoryType;

                if (!dates.labels.includes(date)) dates.labels.push(date);

                const rate = rlCurrency === 'RUB' && wmCurrency === 'WMR' ? item.Rate : (item.Amount.replace(',', '.') / item.AmountWm.replace(',', '.')).toFixed(4);

                if (item.BidsHistoryType === 'buy') {
                    dates.lineRates_buy.push(rate);
                    dates.lineLabels_buy.push(item.FinishedAt + '\n' + 'Количество: ' + item.AmountWm);
                }
                else {
                    dates.lineRates_sale.push(rate);
                    dates.lineLabels_sale.push(item.FinishedAt + '\n' + 'Количество: ' + item.AmountWm);
                }
                
                dates[type][date] = +((dates[type][date]  || 0 ) + (+item.AmountWm.replace(',', '.'))).toFixed(1);
            }

        const buy_days = Object.values(dates.buy);
        const sale_days = Object.values(dates.sale);

        const maxBuyRate = Math.max(...dates.lineRates_buy);
        const maxSaleRate = Math.max(...dates.lineRates_sale);

        for (let i = 0; i < dates.lineRates_buy.length; i++) {
            dates.colorsBuy.push(`hsla(0, 100%, ${(dates.lineRates_buy[i] / maxBuyRate) * 50}%, 1)`);
        }
        for (let i = 0; i < dates.lineRates_sale.length; i++) {
            dates.colorsSale.push(`hsla(120, 100%, ${Math.abs(dates.lineRates_sale[i] / maxSaleRate)}%, 1)`);
        }
        
        createChartLine(ctx_lineBuy, 'buy', dates.lineLabels_buy, dates.lineRates_buy, 'Покупка', dates.colorsBuy);
        createChartLine(ctx_lineSale, 'sale', dates.lineLabels_sale, dates.lineRates_sale, 'Продажа', dates.colorsSale);
        createChartBar('days', ctx_days, dates.labels, buy_days, sale_days, 'Дни');

        const buy_weeks = [];
        const sale_weeks = [];
        const labels = [];
        
        for (let i = 0, p = 0; i < buy_days.length; i++) {
            if (i !== 0 && i % 7 === 0) p++;
            buy_weeks[p] = +((buy_weeks[p] || 0) + buy_days[i]).toFixed(1);
        }

        for (let i = 0, p = 0; i < sale_days.length; i++) {
            if (i !== 0 && i % 7 === 0) p++;
            sale_weeks[p] = +((sale_weeks[p] || 0) + sale_days[i]).toFixed(1);
        }

        for (let i = 0, p = 0; i < dates.labels.length; i += 6) {
            labels.unshift(`${dates.labels[i]} - ${dates.labels[i + 6] || dates.labels[dates.labels.length - 1]}`);
        }
        createChartBar('weeks', ctx_weeks, labels, buy_weeks, sale_weeks, 'Недели');
    })
    .catch(err => console.error(err));
    }
    
    






















    
    function createChartBar(chart, ctx, labels, buy, sale, title) {
        if (charts.bar[chart] !== null) {
            charts.bar[chart].data.labels = labels;
            
            charts.bar[chart].data.datasets[0].data = buy;
            charts.bar[chart].data.datasets[1].data = sale;
            charts.bar[chart].update();
            return;
        }

        charts.bar[chart] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                {
                    label: 'Покупка',
                    data: buy,
                    backgroundColor: '#00C0EF'
                },
                {
                    label: 'Продажа',
                    data: sale,
                    backgroundColor: '#00A65A'
                }
            ]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: title,
                    fontSize: 25,
                    fontColor: '#fff'
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            fontColor: '#fff'
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            fontColor: '#fff'
                        }
                    }]
                }
            }
        });
    }
    function createChartLine(ctx, type, labels, rate, title, colors,) {
        if (charts.line[type] !== null) {
            charts.line[type].data.labels = labels;
            charts.line[type].data.datasets[0].data = rate;
            charts.line[type].update();
            return;
        }

        charts.line[type] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                {
                    label: title,
                    data: rate,
                    backgroundColor: colors,
                }
            ]
            },
            options: {
                title: {
                    display: true,
                    text: 'Курс каждой сделки',
                    fontSize: 25,
                    fontColor: '#fff'
                },
                elements: {
                    line: {
                        fill: false,
                        borderColor: 'rgba(0, 192, 239, 0.2)',
                        tension: 0
                    },
                    point: {
                        radius: 5
                    }
                },
                scales:{
                    xAxes: [{
                        display: false,
                        gridLines: {
                            display: false
                        }
                    }],
                    yAxes: [{
                        ticks: {
                            fontColor: '#fff'
                        }
                    }]
                },
                layout: {
                    padding: {
                        right: 5
                    }
                }
            }
        });
    }
</script>
</html>